---
alwaysApply: true
---
## Critical Security Rules

### 1. Credential Detection and Protection

**MANDATORY: Scan for sensitive patterns before any file operations:**

```markdown
**Credential Patterns to Detect:**

ğŸ”‘ API Keys & Tokens:
- `api_key`, `apikey`, `api-key` followed by `=`, `:`, or `"`
- `token`, `bearer`, `jwt` followed by `=`, `:`, or `"`
- `secret`, `password`, `pwd` followed by `=`, `:`, or `"`
- `private_key`, `client_secret`, `auth_token`
- Base64 encoded strings > 32 characters in config contexts

ğŸ—„ï¸ Database & Infrastructure:
- Connection strings: `mongodb://`, `postgres://`, `mysql://`, `redis://`
- Database passwords: `DB_PASSWORD`, `DATABASE_URL`
- Cloud credentials: `AWS_ACCESS_KEY`, `AZURE_`, `GCP_`
- SSH keys: `-----BEGIN`, `ssh-rsa`, `ssh-ed25519`
```

**Credential Management Workflow:**

```markdown
**When credentials detected in files:**

ğŸ”´ STOP IMMEDIATELY - Do not proceed with file operations

**For NEW files with credentials:**
1. Create template version with placeholders
2. Replace credentials with `YOUR_API_KEY_HERE`
3. Add template to git: `git add config.template.js`
4. Ignore original: `git update-index --skip-worktree config.js`
5. Add to .gitignore: `echo "config.js" >> .gitignore`

**For EXISTING files:**
- Use: `git update-index --skip-worktree filename`
- Notify team about credential exposure risk
```

**Template Creation:**

```javascript
// âœ… GOOD: config.template.js
module.exports = {
  apiKey: 'YOUR_API_KEY_HERE',
  databaseUrl: 'YOUR_DATABASE_URL_HERE',
  jwtSecret: 'YOUR_JWT_SECRET_HERE'
};

// âŒ NEVER COMMIT: config.js
module.exports = {
  apiKey: 'sk-1234567890abcdef...',
  databaseUrl: 'mongodb://user:pass@host:port/db',
  jwtSecret: 'super-secret-key-12345'
};
```

### 2. Input Validation

**Validate All External Input:**

```markdown
**Input Validation Checklist:**

ğŸ” Data Type Validation:
- [ ] Check data types (string, number, boolean)
- [ ] Validate required fields are present
- [ ] Check field length limits
- [ ] Validate format patterns (email, URL, etc.)

ğŸš« Sanitization:
- [ ] Remove potentially dangerous characters
- [ ] Encode special characters for output context
- [ ] Validate against allowlists when possible
- [ ] Reject known malicious patterns
```

**Integration:** [Development Workflow](development-workflow.mdc#code-quality-maintenance)

### 3. Secure Error Handling

**Never Expose Internal Details:**

```markdown
**Error Handling Guidelines:**

âœ… GOOD Error Messages:
- "Invalid email format. Please check your input."
- "Authentication failed. Please verify your credentials."
- "Resource not found. Please check the ID and try again."
- "Service temporarily unavailable. Please try again later."

âŒ AVOID Exposing:
- Database error messages
- File system paths
- API keys or credentials
- Internal server details
- Stack traces in production
```

## Advanced Security Patterns

### 4. Secure Logging Practices

**Log Security Events Appropriately:**

```markdown
**Logging Security Guidelines:**

ğŸ”’ ALWAYS LOG:
- Authentication attempts (success/failure)
- Authorization failures
- Input validation failures
- Security-relevant configuration changes
- Suspicious activity patterns

ğŸš« NEVER LOG:
- Passwords or API keys
- Full request/response bodies with sensitive data
- Credit card numbers or personal identifiers
- Session tokens or authentication credentials
```

**Secure Logging Implementation:**

```javascript
// âœ… GOOD: Secure logging
function logSecurityEvent(eventType, details) {
  // Sanitize sensitive data before logging
  const sanitizedDetails = {
    ...details,
    password: '[REDACTED]',
    apiKey: '[REDACTED]',
    token: '[REDACTED]'
  };

  securityLogger.info(`Security Event: ${eventType}`, {
    event: eventType,
    timestamp: new Date().toISOString(),
    userId: details.userId || 'anonymous',
    ipAddress: details.ipAddress,
    userAgent: details.userAgent,
    details: sanitizedDetails
  });
}

// Usage examples
logSecurityEvent('LOGIN_ATTEMPT', {
  userId: '12345',
  ipAddress: '192.168.1.1',
  success: false,
  reason: 'invalid_password'
});

logSecurityEvent('INPUT_VALIDATION_FAILURE', {
  field: 'email',
  value: '[SANITIZED]',
  expectedFormat: 'email',
  source: 'user_registration'
});
```

### 5. Dependency Security

**Secure Third-Party Dependencies:**

```markdown
**Dependency Security Checklist:**

ğŸ“¦ Before Adding Dependencies:
- [ ] Check package reputation and maintenance status
- [ ] Review security audit results
- [ ] Verify package source and author
- [ ] Check for known vulnerabilities

ğŸ”„ Regular Maintenance:
- [ ] Run security audits weekly: `npm audit` or equivalent
- [ ] Update dependencies regularly
- [ ] Monitor security advisories
- [ ] Remove unused dependencies

âš ï¸ Risk Assessment:
- [ ] Avoid packages with recent security issues
- [ ] Prefer established, well-maintained packages
- [ ] Review packages with excessive permissions
- [ ] Validate packages that access file system or network
```

**Dependency Audit Script:**

```bash
#!/bin/bash
# Security audit script for dependencies

echo "ğŸ” Running security audit..."

# Check for vulnerabilities
npm audit --audit-level moderate

# Check for outdated packages
npm outdated

# List packages with unusual permissions
echo "ğŸ“‹ Checking package permissions..."
npm ls --depth=0

echo "âœ… Security audit complete"
```

### 6. API Security

**Secure External API Interactions:**

```markdown
**API Security Guidelines:**

ğŸŒ HTTPS Everywhere:
- [ ] Always use HTTPS for API calls
- [ ] Validate SSL/TLS certificates
- [ ] Never disable certificate validation
- [ ] Use proper certificate pinning if available

ğŸ”‘ Authentication:
- [ ] Use secure authentication methods (OAuth, JWT)
- [ ] Rotate API keys regularly
- [ ] Implement proper token storage
- [ ] Use least-privilege access principles

â±ï¸ Rate Limiting:
- [ ] Implement client-side rate limiting
- [ ] Handle rate limit responses gracefully
- [ ] Use exponential backoff for retries
- [ ] Monitor API usage patterns
```

## Security Testing

### 7. Security Test Patterns

**Test Security Controls:**

```markdown
**Security Testing Checklist:**

ğŸ§ª Input Validation Tests:
- [ ] Test with empty/null inputs
- [ ] Test with oversized inputs
- [ ] Test with special characters and injection attempts
- [ ] Test with malformed data types

ğŸ” Authentication Tests:
- [ ] Test with invalid credentials
- [ ] Test with expired tokens
- [ ] Test with missing authentication
- [ ] Test privilege escalation attempts

ğŸ›¡ï¸ Error Handling Tests:
- [ ] Verify no sensitive data in error responses
- [ ] Test error message consistency
- [ ] Verify proper HTTP status codes
- [ ] Test error logging functionality
```

**Integration:** [Quality Control](quality-control.mdc#security-testing)

---

## Incident Response

### 8. Security Incident Handling

**When Security Issues Are Discovered:**

```markdown
**Immediate Response (First 10 minutes):**

ğŸš¨ CRITICAL Actions:
1. Stop deployment of affected code
2. Revoke compromised credentials immediately
3. Document exact time and scope of discovery
4. Notify security team/stakeholders

ğŸ“‹ Assessment (Next 30 minutes):
1. Determine scope of potential exposure
2. Identify affected systems and data
3. Check logs for evidence of exploitation
4. Estimate timeline of vulnerability existence

ğŸ”§ Remediation:
1. Fix vulnerability in code
2. Deploy security patches
3. Rotate all potentially affected credentials
4. Update security tests to prevent recurrence
5. Document lessons learned
```

**Post-Incident Documentation:**

```markdown
**Security Incident Report Template:**

**Incident ID:** SEC-2025-001
**Date/Time:** 2025-01-15 14:30 UTC
**Severity:** High/Medium/Low
**Status:** Resolved

**Summary:**
Brief description of the security issue and impact.

**Timeline:**
- 14:30 - Issue discovered during code review
- 14:35 - Credentials rotated
- 14:45 - Fix deployed
- 15:00 - Verification complete

**Root Cause:**
API key was accidentally committed to repository.

**Impact:**
Potential unauthorized access to external API for 2 hours.

**Resolution:**
- Rotated API key
- Added pre-commit hooks for credential detection
- Updated .gitignore patterns
- Enhanced security training

**Prevention:**
- Implement automated credential scanning
- Enhanced code review checklist
- Regular security audit schedule
```

---

## Quick Implementation Guide

**âœ… Start Today:**
- [ ] Scan current codebase for hardcoded credentials
- [ ] Add input validation to user-facing functions
- [ ] Review error messages for sensitive data exposure
- [ ] Set up environment variables for configuration

**âœ… This Week:**
- [ ] Implement comprehensive input validation
- [ ] Set up secure logging practices
- [ ] Add security tests to test suite
- [ ] Create credential detection pre-commit hooks

**âœ… Advanced Implementation:**
- [ ] Integrate with [Quality Control](quality-control.mdc) for security testing
- [ ] Establish security incident response procedures
- [ ] Create security audit schedule
- [ ] Develop team security training program

---

**Next Steps:** Review [Quality Control](quality-control.mdc) for security testing integration or [Problem-Solving](problem-solving.mdc) for systematic security issue investigation.
description:
globs:
alwaysApply: false
---
